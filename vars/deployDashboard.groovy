#!/usr/bin/env groovy

import groovy.json.JsonSlurper

//Start Stage
stage('Dashboard Creation'){

 try {

    // AKS metrics parameters are omitted in UI till approach is finalized, hence, setting all UI parameters here to default to run the pipeline
    def aksmetricsRequired = false
    def openshiftMetricsRequired = '${aksmetricsRequired}'
    def namespace = ''
    def servicename = ''
    def deploymentnumber = ''

    echo "Dashboard creation for environment ${environment}, service ${artifact} related to the project ${projectname} started. AKS metrics is marked as ${openshiftMetricsRequired} for this dashboard"
          

    // Dont modify beyond this point
    def elasticSearchEndpoint = "${elasticServer}"
    def grafanaEndpoint = "${grafanaServer}"
    def datasourceEndpoint = "${grafanaEndpoint}/api/datasources"
    def dashboardEndpoint = "${grafanaEndpoint}/api/dashboards/db"
    
    def updateddashboardname = "${artifact} ${environment}" 
    

    // Datasource JSON Body
    def containerbody = """{"name": "filebeat.${environment}.logevent-${artifact}", "type": "elasticsearch", "typeLogoUrl": "public/app/plugins/datasource/elasticsearch/img/elasticsearch.svg", "access": "proxy", "url": "${elasticSearchEndpoint}", "database": "filebeat.${environment}.logevent-${artifact}*", "basicAuth": false, "isDefault": false, "jsonData": {"esVersion": 60,"keepCookies": [],"logLevelField": "loglevel","logMessageField": "message", "maxConcurrentShardRequests": "5","timeField": "ts"},"readOnly": false}"""

    // Fetch Grafana User
    withCredentials([string(credentialsId: "grafana_user", variable: "grafanaUser")]) {

    // Create Container Logs Datasource
    def conhttp = new URL("${datasourceEndpoint}").openConnection() as HttpURLConnection
    conhttp.setRequestMethod('POST')
    conhttp.setDoOutput(true)
    conhttp.setRequestProperty("Accept", 'application/json')
    conhttp.setRequestProperty("Content-Type", 'application/json')
    conhttp.setRequestProperty("Authorization", "${grafanaUser}")
    conhttp.outputStream.write(containerbody.getBytes("UTF-8"))
    conhttp.connect()

    def conresponse = [: ]
    if (conhttp.responseCode == 200) {
     conresponse = new JsonSlurper().parseText(conhttp.inputStream.getText('UTF-8'))
     echo "Container Logs DataSource Created  ${conhttp.responseCode} : ${conresponse}"
    } else if (conhttp.responseCode == 409) {
     conresponse = new JsonSlurper().parseText(conhttp.errorStream.getText('UTF-8'))
     echo "Container DataSource already exist for the artifact ${artifact} in ${environment} environment"
    } else {
     conresponse = new JsonSlurper().parseText(conhttp.errorStream.getText('UTF-8'))
     echo "There is an issue while creating the Datasource and the reason for that is ${conhttp.responseCode} : ${conresponse}"
     currentBuild.result = 'FAILURE'
    }

    def dashboardbody = null

    if ("true" == "${openshiftMetricsRequired}") {
        def servicenamewithversion = "${servicename}-${deploymentnumber}"
        echo "${grafanaEndpoint}"
        echo "${updateddashboardname}"
        // Dashboard JSON Body
        dashboardbody = $/  { "dashboard":{ "annotations":{ "list":[ { "builtIn":1, "datasource":"-- Grafana --", "enable":true, "hide":true, "iconColor":"rgba(0, 211, 255, 1)", "limit":100, "matchAny":true, "name":"Annotations & Alerts", "showIn":0, "tags":[ "monitoring", "${environment}", "Filebeat", "${projectname}" ], "type":"tags" } ] }, "editable":true, "gnetId":null, "graphTooltip":0, "iteration":1575040503495, "links":[ ], "panels":[ { "collapsed":false, "gridPos":{ "h":1, "w":24, "x":0, "y":0 }, "id":16, "panels":[ ], "repeat":null, "title":"Functional Logger", "type":"row" }, { "cacheTimeout":null, "colorBackground":false, "colorValue":false, "colors":[ "#299c46", "#DEB6F2", "#d44a3a" ], "datasource":"filebeat.${environment}.logevent-${artifact}", "format":"none", "gauge":{ "maxValue":100, "minValue":0, "show":false, "thresholdLabels":false, "thresholdMarkers":true }, "gridPos":{ "h":5, "w":3, "x":0, "y":1 }, "id":4, "interval":null, "links":[ ], "mappingType":1, "mappingTypes":[ { "name":"value to text", "value":1 }, { "name":"range to text", "value":2 } ], "maxDataPoints":100, "nullPointMode":"connected", "nullText":null, "options":{ }, "pluginVersion":"6.3.2", "postfix":"", "postfixFontSize":"50%", "prefix":"", "prefixFontSize":"50%", "rangeMaps":[ { "from":"null", "text":"N/A", "to":"null" } ], "sparkline":{ "fillColor":"rgba(31, 118, 189, 0.18)", "full":false, "lineColor":"rgb(31, 120, 193)", "show":false, "ymax":null, "ymin":null }, "tableColumn":"", "targets":[ { "bucketAggs":[ { "field":"ts", "id":"2", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "meta":{ }, "settings":{ }, "type":"count" } ], "query":"(loglevel: $$logLevel) && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "thresholds":"2,3", "timeFrom":null, "timeShift":null, "title":"Number of $${logLevel} messages", "transparent":true, "type":"singlestat", "valueFontSize":"80%", "valueMaps":[ { "op":"=", "text":"N/A", "value":"null" } ], "valueName":"total" }, { "aliasColors":{ "200":"semi-dark-green", "500":"super-light-red", "501":"light-red", "502":"semi-dark-red", "ERROR 400":"rgb(215, 0, 255)", "ERROR 401":"rgb(185, 0, 255)", "ERROR 402":"super-light-orange", "ERROR 403":"rgb(155, 0, 255)", "ERROR 404":"dark-blue", "ERROR 405":"rgb(125, 0, 255)", "ERROR 408":"rgb(95, 0, 255)", "ERROR 409":"rgb(55, 0, 255)", "ERROR 429":"dark-red", "ERROR 500":"rgb(255, 30, 0)", "ERROR 501":"rgb(255, 60, 60)", "ERROR 502":"rgb(255, 60, 0)", "ERROR 503":"rgb(255, 90, 0)", "ERROR 504":"rgb(255, 120, 0)", "ERROR 505":"rgb(255, 150, 0)", "INFO 200":"dark-green", "INFO 201":"semi-dark-green" }, "bars":false, "dashLength":10, "dashes":false, "datasource":"filebeat.${environment}.logevent-${artifact}", "fill":1, "fillGradient":0, "gridPos":{ "h":5, "w":21, "x":3, "y":1 }, "id":2, "legend":{ "avg":false, "current":false, "max":false, "min":false, "show":true, "total":false, "values":false }, "lines":true, "linewidth":1, "links":[ ], "nullPointMode":"null", "options":{ "dataLinks":[ ] }, "percentage":false, "pointradius":2, "points":false, "renderer":"flot", "seriesOverrides":[ { "alias":"200", "yaxis":1 } ], "spaceLength":10, "stack":true, "steppedLine":false, "targets":[ { "bucketAggs":[ { "fake":true, "field":"logLevel", "id":"6", "settings":{ "min_doc_count":1, "order":"desc", "orderBy":"_term", "size":"20" }, "type":"terms" }, { "fake":true, "field":"transactionStatusCode", "id":"5", "settings":{ "min_doc_count":1, "order":"desc", "orderBy":"_term", "size":"20" }, "type":"terms" }, { "field":"ts", "id":"2", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"4", "type":"count" } ], "query":"(logLevel: $$logLevel) && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "thresholds":[ ], "timeFrom":null, "timeRegions":[ ], "timeShift":null, "title":"$${logLevel} messages over time grouped by statusCode", "tooltip":{ "shared":true, "sort":0, "value_type":"individual" }, "transparent":true, "type":"graph", "xaxis":{ "buckets":null, "mode":"time", "name":null, "show":true, "values":[ ] }, "yaxes":[ { "format":"short", "label":null, "logBase":1, "max":null, "min":null, "show":true }, { "format":"short", "label":null, "logBase":1, "max":null, "min":null, "show":true } ], "yaxis":{ "align":false, "alignLevel":null } }, { "cacheTimeout":null, "datasource":"filebeat.${environment}.logevent-${artifact}", "gridPos":{ "h":4, "w":24, "x":0, "y":6 }, "id":35, "links":[ ], "options":{ "displayMode":"gradient", "fieldOptions":{ "calcs":[ "sum" ], "defaults":{ "decimals":0, "mappings":[ ], "max":10, "min":0, "thresholds":[ { "color":"green", "value":null }, { "color":"dark-orange", "value":1 }, { "color":"dark-red", "value":3 } ], "title":"Pod: $$__series_name", "unit":"none" }, "override":{ }, "values":false }, "orientation":"horizontal" }, "pluginVersion":"6.3.2", "targets":[ { "bucketAggs":[ { "fake":true, "field":"host.name", "id":"4", "settings":{ "min_doc_count":1, "missing":null, "order":"desc", "orderBy":"_count", "size":"0" }, "type":"terms" }, { "fake":true, "field":"ts", "id":"3", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "meta":{ }, "settings":{ }, "type":"count" } ], "query":"(logLevel: \"ERROR\") && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "timeFrom":"now-1h", "timeShift":null, "title":"Number of errors in the past hour", "transparent":true, "type":"bargauge" }, { "cacheTimeout":null, "datasource":"filebeat.${environment}.logevent-${artifact}", "gridPos":{ "h":8, "w":8, "x":0, "y":10 }, "id":33, "links":[ ], "options":{ "fieldOptions":{ "calcs":[ "sum" ], "defaults":{ "mappings":[ ], "max":10, "min":0, "thresholds":[ { "color":"green", "value":null }, { "color":"dark-orange", "value":1 }, { "color":"dark-red", "value":2 } ] }, "override":{ }, "values":false }, "orientation":"auto", "showThresholdLabels":false, "showThresholdMarkers":true }, "pluginVersion":"6.3.2", "targets":[ { "bucketAggs":[ { "fake":true, "field":"ts", "id":"3", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "type":"count" } ], "query":"(logLevel: \"ERROR\") && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "timeFrom":null, "timeShift":null, "title":"Total failed transactions", "transparent":true, "type":"gauge" }, { "aliasColors":{ "200":"#37872D", "201":"#56A64B", "400":"rgb(215, 0, 255)", "401":"rgb(185, 0, 255)", "403":"rgb(155, 0, 255)", "404":"#1F60C4", "405":"rgb(125, 0, 255)", "408":"rgb(95, 0, 255)", "409":"rgb(55, 0, 255)", "429":"#c4162a", "500":"rgb(255, 30, 0)", "501":"rgb(255, 60, 60)", "502":"rgb(255, 60, 0)", "503":"rgb(255, 90, 0)", "504":"rgb(255, 120, 0)", "505":"rgb(255, 150, 0)" }, "breakPoint":"50%", "cacheTimeout":null, "combine":{ "label":"Others", "threshold":0 }, "datasource":"filebeat.${environment}.logevent-${artifact}", "fontSize":"80%", "format":"short", "gridPos":{ "h":8, "w":8, "x":8, "y":10 }, "id":6, "interval":null, "legend":{ "show":true, "values":true }, "legendType":"Right side", "links":[ ], "maxDataPoints":3, "nullPointMode":"connected", "options":{ }, "pieType":"pie", "strokeWidth":1, "targets":[ { "bucketAggs":[ { "fake":true, "field":"transactionStatusCode", "id":"4", "settings":{ "min_doc_count":1, "order":"desc", "orderBy":"_term", "size":"15" }, "type":"terms" }, { "fake":true, "field":"ts", "id":"3", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "type":"count" } ], "query":"(logLevel: $$logLevel) && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "timeFrom":null, "timeShift":null, "title":"$${logLevel} messages grouped by status code", "transparent":true, "type":"grafana-piechart-panel", "valueName":"total" }, { "aliasColors":{ "/ah/test-api/v1/healthchock":"#8AB8FF" }, "breakPoint":"50%", "cacheTimeout":null, "combine":{ "label":"Others", "threshold":0 }, "datasource":"filebeat.${environment}.logevent-${artifact}", "fontSize":"80%", "format":"short", "gridPos":{ "h":8, "w":8, "x":16, "y":10 }, "id":7, "interval":null, "legend":{ "header":"", "show":true, "sideWidth":null, "values":true }, "legendType":"Under graph", "links":[ ], "maxDataPoints":3, "nullPointMode":"connected", "options":{ }, "pieType":"pie", "strokeWidth":1, "targets":[ { "bucketAggs":[ { "fake":true, "field":"invokedEndpoint.keyword", "id":"4", "settings":{ "min_doc_count":1, "order":"desc", "orderBy":"_term", "size":"0" }, "type":"terms" }, { "fake":true, "field":"ts", "id":"3", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "type":"count" } ], "query":"(logLevel: $$logLevel) && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "timeFrom":null, "timeShift":null, "title":"$${logLevel} messages grouped by requested endpoint", "transparent":true, "type":"grafana-piechart-panel", "valueName":"total" }, { "bgColor":null, "datasource":"filebeat.${environment}.logevent-${artifact}", "gridPos":{ "h":7, "w":24, "x":0, "y":18 }, "hideTimeOverride":true, "id":37, "options":{ }, "targets":[ { "bucketAggs":[ { "fake":true, "field":"invokedEndpoint.keyword", "id":"3", "settings":{ "min_doc_count":1, "missing":"0", "order":"desc", "orderBy":"_term", "size":"10" }, "type":"terms" }, { "field":"ts", "id":"2", "settings":{ "interval":"1d", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "hide":false, "metrics":[ { "field":"select field", "id":"1", "type":"count" } ], "query":"logLevel:\"ERROR\" AND tags:\"mule-application\"", "refId":"A", "timeField":"ts" } ], "timeFrom":"now-1y", "timeShift":null, "title":"Status of endpoints past 24h", "trafficLightSettings":{ "digits":0, "fontColor":"#FA6400", "fontSize":"12px", "greenThreshold":0, "invertScale":true, "lightsPerLine":5, "linkTargetBlank":false, "linkTooltip":"", "linkUrl":"", "max":100, "redThreshold":3, "renderLink":false, "showTrend":false, "showValue":true, "sortLights":true, "spreadControls":true, "units":" errors", "width":50 }, "transparent":true, "type":"snuids-trafficlights-panel" }, { "bgColor":null, "datasource":"filebeat.${environment}.logevent-${artifact}", "gridPos":{ "h":7, "w":24, "x":0, "y":25 }, "hideTimeOverride":true, "id":44, "options":{ }, "targets":[ { "bucketAggs":[ { "fake":true, "field":"host.name", "id":"3", "settings":{ "min_doc_count":1, "missing":"0", "order":"desc", "orderBy":"_term", "size":"10" }, "type":"terms" }, { "field":"ts", "id":"2", "settings":{ "interval":"1d", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "hide":false, "metrics":[ { "field":"select field", "id":"1", "type":"count" } ], "query":"logLevel:\"ERROR\" AND tags:\"mule-application\"", "refId":"A", "timeField":"ts" } ], "timeFrom":"now-2d", "timeShift":null, "title":"Status of host pods past 24h", "trafficLightSettings":{ "digits":0, "fontColor":"#FA6400", "fontSize":"12px", "greenThreshold":0, "invertScale":true, "lightsPerLine":5, "linkTargetBlank":false, "linkTooltip":"", "linkUrl":"", "max":100, "redThreshold":3, "renderLink":false, "showTrend":false, "showValue":true, "sortLights":true, "spreadControls":true, "units":" errors", "width":50 }, "transparent":true, "type":"snuids-trafficlights-panel" }, { "columns":[ { "text":"ts", "value":"ts" }, { "text":"host.name", "value":"host.name" }, { "text":"logLevel", "value":"logLevel" }, { "text":"httpMethod", "value":"httpMethod" }, { "text":"invokedEndpoint", "value":"invokedEndpoint" }, { "text":"transactionStatusCode", "value":"transactionStatusCode" }, { "text":"transactionStatusMessage", "value":"transactionStatusMessage" }, { "text":"payload.dataContent.error.errorMessage", "value":"payload.dataContent.error.errorMessage" }, { "text":"payload.dataContent.error.errorDescription", "value":"payload.dataContent.error.errorDescription" } ], "datasource":"filebeat.${environment}.logevent-${artifact}", "fontSize":"80%", "gridPos":{ "h":7, "w":24, "x":0, "y":32 }, "id":43, "links":[ ], "options":{ }, "pageSize":0, "scroll":true, "showHeader":true, "sort":{ "col":5, "desc":true }, "styles":[ { "alias":"Time", "dateFormat":"YYYY-MM-DD HH:mm:ss.SSS", "link":false, "pattern":"ts", "type":"date" }, { "alias":"HTTP Method", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "decimals":2, "pattern":"httpMethod", "thresholds":[ ], "type":"string", "unit":"short" }, { "alias":"Endpoint", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"invokedEndpoint", "thresholds":[ ], "type":"string", "unit":"short" }, { "alias":"Transaction status code", "colorMode":"row", "colors":[ "rgba(50, 172, 45, 0)", "rgba(89, 48, 16, 0.89)", "rgba(245, 54, 54, 0)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"transactionStatusCode", "thresholds":[ "400" ], "type":"string", "unit":"short" }, { "alias":"Level", "colorMode":null, "colors":[ "rgba(50, 172, 45, 0.97)", "rgba(237, 129, 40, 0.89)", "rgba(245, 54, 54, 0.9)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"logLevel", "rangeMaps":[ ], "thresholds":[ "WARN", " ERROR" ], "type":"string", "unit":"short" }, { "alias":"Payload Message", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"transactionStatusMessage", "preserveFormat":false, "rangeMaps":[ { "from":"", "text":"", "to":"" } ], "sanitize":false, "thresholds":[ ], "type":"string", "unit":"short", "valueMaps":[ ] }, { "alias":"Transaction description", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"payload.dataContent.error.errorDescription", "thresholds":[ ], "type":"string", "unit":"short" }, { "alias":"Error Message", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"payload.dataContent.error.errorMessage", "thresholds":[ ], "type":"number", "unit":"short" }, { "alias":"Pod Name", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"host.name", "thresholds":[ ], "type":"number", "unit":"short" } ], "targets":[ { "bucketAggs":[ ], "metrics":[ { "field":"select field", "id":"1", "meta":{ }, "settings":{ "size":500 }, "type":"raw_document" } ], "query":"(logLevel: $$logLevel) && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "timeFrom":null, "timeShift":null, "title":"$${logLevel} Log messages", "transform":"json", "transparent":true, "type":"table" }, { "collapsed":false, "gridPos":{ "h":1, "w":24, "x":0, "y":39 }, "id":46, "panels":[ ], "title":"Platform Metrics", "type":"row" }, { "aliasColors":{ }, "bars":false, "dashLength":10, "dashes":false, "datasource":"openshift-monitoring-datasource", "fill":1, "fillGradient":0, "gridPos":{ "h":8, "w":11, "x":0, "y":40 }, "id":48, "legend":{ "avg":false, "current":false, "max":false, "min":false, "show":true, "total":false, "values":false }, "lines":true, "linewidth":1, "nullPointMode":"null", "options":{ "dataLinks":[ ] }, "percentage":false, "pointradius":2, "points":false, "renderer":"flot", "seriesOverrides":[ ], "spaceLength":10, "stack":false, "steppedLine":false, "targets":[ { "expr":"namespace_pod_name_container_name:container_cpu_usage_seconds_total:sum_rate{namespace=\"${namespace}\", pod_name=~\"${servicenamewithversion}.*\", container_name!=\"POD\"}", "legendFormat":"{{pod_name}}", "refId":"A" } ], "thresholds":[ ], "timeFrom":null, "timeRegions":[ ], "timeShift":null, "title":"CPU Usage", "tooltip":{ "shared":true, "sort":0, "value_type":"individual" }, "type":"graph", "xaxis":{ "buckets":null, "mode":"time", "name":null, "show":true, "values":[ ] }, "yaxes":[ { "format":"short", "label":null, "logBase":1, "max":null, "min":null, "show":true }, { "format":"short", "label":null, "logBase":1, "max":null, "min":null, "show":true } ], "yaxis":{ "align":false, "alignLevel":null } }, { "aliasColors":{ }, "bars":false, "dashLength":10, "dashes":false, "datasource":"openshift-monitoring-datasource", "fill":1, "fillGradient":0, "gridPos":{ "h":8, "w":12, "x":11, "y":40 }, "id":50, "legend":{ "avg":false, "current":false, "max":false, "min":false, "show":true, "total":false, "values":false }, "lines":true, "linewidth":1, "nullPointMode":"null", "options":{ "dataLinks":[ ] }, "percentage":false, "pointradius":2, "points":false, "renderer":"flot", "seriesOverrides":[ ], "spaceLength":10, "stack":false, "steppedLine":false, "targets":[ { "expr":"namespace_name:container_memory_usage_bytes:sum{namespace=\"${namespace}\",label_name=\"${servicename}\"}", "legendFormat":"${servicename}", "refId":"A" } ], "thresholds":[ ], "timeFrom":null, "timeRegions":[ ], "timeShift":null, "title":"Memory Usage", "tooltip":{ "shared":true, "sort":0, "value_type":"individual" }, "type":"graph", "xaxis":{ "buckets":null, "mode":"time", "name":null, "show":true, "values":[ ] }, "yaxes":[ { "format":"short", "label":null, "logBase":1, "max":null, "min":null, "show":true }, { "format":"short", "label":null, "logBase":1, "max":null, "min":null, "show":true } ], "yaxis":{ "align":false, "alignLevel":null } }, { "collapsed":false, "gridPos":{ "h":1, "w":24, "x":0, "y":48 }, "id":18, "panels":[ ], "title":"System Logger", "type":"row" }, { "cacheTimeout":null, "colorBackground":false, "colorValue":false, "colors":[ "#299c46", "rgba(237, 129, 40, 0.89)", "#d44a3a" ], "datasource":"filebeat.${environment}.logevent-${artifact}", "format":"none", "gauge":{ "maxValue":100, "minValue":0, "show":false, "thresholdLabels":false, "thresholdMarkers":true }, "gridPos":{ "h":5, "w":3, "x":0, "y":49 }, "id":27, "interval":null, "links":[ ], "mappingType":1, "mappingTypes":[ { "name":"value to text", "value":1 }, { "name":"range to text", "value":2 } ], "maxDataPoints":100, "nullPointMode":"connected", "nullText":null, "options":{ }, "pluginVersion":"6.3.2", "postfix":"", "postfixFontSize":"50%", "prefix":"", "prefixFontSize":"50%", "rangeMaps":[ { "from":"null", "text":"N/A", "to":"null" } ], "sparkline":{ "fillColor":"rgba(31, 118, 189, 0.18)", "full":false, "lineColor":"rgb(31, 120, 193)", "show":false, "ymax":null, "ymin":null }, "tableColumn":"", "targets":[ { "bucketAggs":[ { "field":"ts", "id":"2", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "meta":{ }, "settings":{ }, "type":"count" } ], "query":"(loglevel = $$logLevel) AND source: $$loggerName", "refId":"A", "timeField":"ts" } ], "thresholds":"", "timeFrom":null, "timeShift":null, "title":"Number of $${logLevel} messages", "transparent":true, "type":"singlestat", "valueFontSize":"80%", "valueMaps":[ { "op":"=", "text":"N/A", "value":"null" } ], "valueName":"total" }, { "aliasColors":{ "Count":"dark-red", "ERROR":"dark-red", "INFO":"semi-dark-green", "WARN":"dark-yellow" }, "bars":false, "dashLength":10, "dashes":false, "datasource":"filebeat.${environment}.logevent-${artifact}", "fill":8, "fillGradient":0, "gridPos":{ "h":10, "w":21, "x":3, "y":49 }, "id":29, "legend":{ "avg":false, "current":false, "max":false, "min":false, "show":true, "total":false, "values":false }, "lines":true, "linewidth":1, "links":[ ], "nullPointMode":"null", "options":{ "dataLinks":[ ] }, "percentage":false, "pointradius":2, "points":false, "renderer":"flot", "seriesOverrides":[ ], "spaceLength":10, "stack":true, "steppedLine":false, "targets":[ { "bucketAggs":[ { "fake":true, "field":"loglevel", "id":"3", "settings":{ "min_doc_count":1, "order":"desc", "orderBy":"_term", "size":"10" }, "type":"terms" }, { "field":"ts", "id":"2", "settings":{ "interval":"5m", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "type":"count" } ], "query":"(loglevel = $$logLevel) AND source: $$loggerName", "refId":"A", "timeField":"ts" } ], "thresholds":[ ], "timeFrom":null, "timeRegions":[ ], "timeShift":null, "title":"$${logLevel} messages over time", "tooltip":{ "shared":true, "sort":0, "value_type":"individual" }, "transparent":true, "type":"graph", "xaxis":{ "buckets":null, "mode":"time", "name":null, "show":true, "values":[ ] }, "yaxes":[ { "format":"short", "label":null, "logBase":1, "max":null, "min":null, "show":true }, { "format":"short", "label":null, "logBase":1, "max":null, "min":null, "show":true } ], "yaxis":{ "align":false, "alignLevel":null } }, { "aliasColors":{ "ERROR":"#C4162A", "INFO":"#56A64B", "WARN":"#E0B400" }, "breakPoint":"50%", "cacheTimeout":null, "combine":{ "label":"Others", "threshold":0 }, "datasource":"filebeat.${environment}.logevent-${artifact}", "fontSize":"80%", "format":"short", "gridPos":{ "h":5, "w":3, "x":0, "y":54 }, "id":41, "interval":null, "legend":{ "show":false, "values":true }, "legendType":"Under graph", "links":[ ], "maxDataPoints":3, "nullPointMode":"connected", "options":{ }, "pieType":"pie", "strokeWidth":1, "targets":[ { "bucketAggs":[ { "fake":true, "field":"loglevel", "id":"4", "settings":{ "min_doc_count":1, "order":"desc", "orderBy":"_term", "size":"10" }, "type":"terms" }, { "field":"ts", "id":"2", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"3", "type":"count" } ], "query":"(loglevel = $$logLevel) AND source: $$loggerName", "refId":"A", "timeField":"ts" } ], "timeFrom":null, "timeShift":null, "title":"Messages grouped by log level", "transparent":true, "type":"grafana-piechart-panel", "valueName":"total" }, { "columns":[ { "text":"ts", "value":"ts" }, { "text":"tags", "value":"tags" }, { "text":"loglevel", "value":"loglevel" }, { "text":"host.name", "value":"host.name" }, { "text":"message", "value":"message" } ], "datasource":"filebeat.${environment}.logevent-${artifact}", "fontSize":"80%", "gridPos":{ "h":7, "w":24, "x":0, "y":59 }, "id":13, "links":[ ], "options":{ }, "pageSize":0, "scroll":true, "showHeader":true, "sort":{ "col":0, "desc":true }, "styles":[ { "alias":"Time", "dateFormat":"YYYY-MM-DD HH:mm:ss.SSS", "link":false, "pattern":"ts", "type":"date" }, { "alias":"Source log", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "decimals":2, "pattern":"tags", "thresholds":[ ], "type":"string", "unit":"short" }, { "alias":"Level", "colorMode":null, "colors":[ "rgba(50, 172, 45, 0.97)", "rgba(237, 129, 40, 0.89)", "rgba(245, 54, 54, 0.9)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"loglevel", "rangeMaps":[ ], "thresholds":[ "\"WARN\"", " \"ERROR\"" ], "type":"string", "unit":"short" } ], "targets":[ { "bucketAggs":[ ], "metrics":[ { "field":"select field", "id":"1", "meta":{ }, "settings":{ "size":500 }, "type":"raw_document" } ], "query":"(loglevel = $$logLevel) AND source: $$loggerName", "refId":"A", "timeField":"ts" } ], "timeFrom":null, "timeShift":null, "title":"$${logLevel} Log messages", "transform":"json", "transparent":true, "type":"table" }, { "content":"# [Full logs available here](${grafanaEndpoint}/explore?orgId=1&left=[\"now/d\",\"now\",\"filebeat.${environment}.logevent-${artifact}\",{\"query\":\"\",\"isLogsQuery\":true},{\"mode\":\"Logs\"},{\"ui\":[true,true,true,\"none\"]}])", "gridPos":{ "h":2, "w":24, "x":0, "y":66 }, "id":39, "links":[ { "title":"Logs", "url":"${grafanaEndpoint}/explore?orgId=1&left=[\"now/d\",\"now\",\"filebeat.${environment}.logevent-${artifact}\",{\"query\":\"\",\"isLogsQuery\":true},{\"mode\":\"Logs\"},{\"ui\":[true,true,true,\"none\"]}]" } ], "mode":"markdown", "options":{ }, "timeFrom":null, "timeShift":null, "title":"", "transparent":true, "type":"text" } ], "refresh":false, "schemaVersion":19, "style":"dark", "tags":[ "monitoring", "${environment}", "Filebeat", "${projectname}" ], "templating":{ "list":[ { "datasource":"filebeat.${environment}.logevent-${artifact}", "filters":[ ], "hide":0, "label":"", "name":"Filters", "skipUrlSync":false, "type":"adhoc" }, { "allValue":"", "current":{ "tags":[ ], "text":"All", "value":[ "$$__all" ] }, "hide":0, "includeAll":true, "label":null, "multi":true, "name":"logLevel", "options":[ { "selected":true, "text":"All", "value":"$$__all" }, { "selected":false, "text":"INFO", "value":"INFO" }, { "selected":false, "text":"WARN", "value":"WARN" }, { "selected":false, "text":"ERROR", "value":"ERROR" }, { "selected":false, "text":"DEBUG", "value":"DEBUG" } ], "query":"INFO,WARN,ERROR,DEBUG", "skipUrlSync":false, "type":"custom" }, { "allValue":"", "current":{ "text":"All", "value":[ "$$__all" ] }, "datasource":"filebeat.${environment}.logevent-${artifact}", "definition":"{\"find\": \"terms\", \"field\": \"httpMethod\"}", "hide":0, "includeAll":true, "label":null, "multi":true, "name":"httpMethod", "options":[ ], "query":"{\"find\": \"terms\", \"field\": \"httpMethod\"}", "refresh":2, "regex":"", "skipUrlSync":false, "sort":0, "tagValuesQuery":"", "tags":[ ], "tagsQuery":"", "type":"query", "useTags":false }, { "allValue":"", "current":{ "text":"All", "value":[ "$$__all" ] }, "datasource":"filebeat.${environment}.logevent-${artifact}", "definition":"{\"find\": \"terms\", \"field\": \"invokedEndpoint.keyword\"}", "hide":0, "includeAll":true, "label":null, "multi":true, "name":"invokedEndpoint", "options":[ ], "query":"{\"find\": \"terms\", \"field\": \"invokedEndpoint.keyword\"}", "refresh":2, "regex":"", "skipUrlSync":false, "sort":2, "tagValuesQuery":"", "tags":[ ], "tagsQuery":"", "type":"query", "useTags":false }, { "allValue":"", "current":{ "tags":[ ], "text":"All", "value":[ "$$__all" ] }, "datasource":"filebeat.${environment}.logevent-${artifact}", "definition":"{\"find\": \"terms\", \"field\": \"source\"}", "hide":0, "includeAll":true, "label":null, "multi":true, "name":"loggerName", "options":[ ], "query":"{\"find\": \"terms\", \"field\": \"source\"}", "refresh":2, "regex":"", "skipUrlSync":false, "sort":2, "tagValuesQuery":"", "tags":[ ], "tagsQuery":"", "type":"query", "useTags":false }, { "allValue":"", "current":{ "text":"All", "value":[ "$$__all" ] }, "datasource":"filebeat.${environment}.logevent-${artifact}", "definition":"{\"find\": \"terms\", \"field\": \"transactionStatusCode\"}", "hide":0, "includeAll":true, "label":"Returned HTTP status code", "multi":true, "name":"transactionStatusCode", "options":[ ], "query":"{\"find\": \"terms\", \"field\": \"transactionStatusCode\"}", "refresh":2, "regex":"", "skipUrlSync":false, "sort":0, "tagValuesQuery":"", "tags":[ ], "tagsQuery":"", "type":"query", "useTags":false } ] }, "time":{ "from":"now/d", "to":"now/d" }, "timepicker":{ "refresh_intervals":[ "5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d" ], "time_options":[ "5m", "15m", "1h", "6h", "12h", "24h", "2d", "7d", "30d" ] }, "timezone":"", "title":"${updateddashboardname} Dashboard", "uid":null, "id":null, "message":"Automatic generation of dashboard", "version":1 } } /$
    }


    else {
        echo "${updateddashboardname}"
        dashboardbody = $/ { "dashboard":{ "annotations":{ "list":[ { "builtIn":1, "datasource":"-- Grafana --", "enable":true, "hide":true, "iconColor":"rgba(0, 211, 255, 1)", "limit":100, "matchAny":true, "name":"Annotations & Alerts", "showIn":0, "tags":[ "monitoring", "${environment}", "Filebeat", "${projectname}" ], "type":"tags" } ] }, "editable":true, "gnetId":null, "graphTooltip":0, "iteration":1575040503495, "links":[ ], "panels":[ { "collapsed":false, "gridPos":{ "h":1, "w":24, "x":0, "y":0 }, "id":16, "panels":[ ], "repeat":null, "title":"Functional Logger", "type":"row" }, { "cacheTimeout":null, "colorBackground":false, "colorValue":false, "colors":[ "#299c46", "#DEB6F2", "#d44a3a" ], "datasource":"filebeat.${environment}.logevent-${artifact}", "format":"none", "gauge":{ "maxValue":100, "minValue":0, "show":false, "thresholdLabels":false, "thresholdMarkers":true }, "gridPos":{ "h":5, "w":3, "x":0, "y":1 }, "id":4, "interval":null, "links":[ ], "mappingType":1, "mappingTypes":[ { "name":"value to text", "value":1 }, { "name":"range to text", "value":2 } ], "maxDataPoints":100, "nullPointMode":"connected", "nullText":null, "options":{ }, "pluginVersion":"6.3.2", "postfix":"", "postfixFontSize":"50%", "prefix":"", "prefixFontSize":"50%", "rangeMaps":[ { "from":"null", "text":"N/A", "to":"null" } ], "sparkline":{ "fillColor":"rgba(31, 118, 189, 0.18)", "full":false, "lineColor":"rgb(31, 120, 193)", "show":false, "ymax":null, "ymin":null }, "tableColumn":"", "targets":[ { "bucketAggs":[ { "field":"ts", "id":"2", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "meta":{ }, "settings":{ }, "type":"count" } ], "query":"(loglevel: $$logLevel) && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "thresholds":"2,3", "timeFrom":null, "timeShift":null, "title":"Number of $${logLevel} messages", "transparent":true, "type":"singlestat", "valueFontSize":"80%", "valueMaps":[ { "op":"=", "text":"N/A", "value":"null" } ], "valueName":"total" }, { "aliasColors":{ "200":"semi-dark-green", "500":"super-light-red", "501":"light-red", "502":"semi-dark-red", "ERROR 400":"rgb(215, 0, 255)", "ERROR 401":"rgb(185, 0, 255)", "ERROR 402":"super-light-orange", "ERROR 403":"rgb(155, 0, 255)", "ERROR 404":"dark-blue", "ERROR 405":"rgb(125, 0, 255)", "ERROR 408":"rgb(95, 0, 255)", "ERROR 409":"rgb(55, 0, 255)", "ERROR 429":"dark-red", "ERROR 500":"rgb(255, 30, 0)", "ERROR 501":"rgb(255, 60, 60)", "ERROR 502":"rgb(255, 60, 0)", "ERROR 503":"rgb(255, 90, 0)", "ERROR 504":"rgb(255, 120, 0)", "ERROR 505":"rgb(255, 150, 0)", "INFO 200":"dark-green", "INFO 201":"semi-dark-green" }, "bars":false, "dashLength":10, "dashes":false, "datasource":"filebeat.${environment}.logevent-${artifact}", "fill":1, "fillGradient":0, "gridPos":{ "h":5, "w":21, "x":3, "y":1 }, "id":2, "legend":{ "avg":false, "current":false, "max":false, "min":false, "show":true, "total":false, "values":false }, "lines":true, "linewidth":1, "links":[ ], "nullPointMode":"null", "options":{ "dataLinks":[ ] }, "percentage":false, "pointradius":2, "points":false, "renderer":"flot", "seriesOverrides":[ { "alias":"200", "yaxis":1 } ], "spaceLength":10, "stack":true, "steppedLine":false, "targets":[ { "bucketAggs":[ { "fake":true, "field":"logLevel", "id":"6", "settings":{ "min_doc_count":1, "order":"desc", "orderBy":"_term", "size":"20" }, "type":"terms" }, { "fake":true, "field":"transactionStatusCode", "id":"5", "settings":{ "min_doc_count":1, "order":"desc", "orderBy":"_term", "size":"20" }, "type":"terms" }, { "field":"ts", "id":"2", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"4", "type":"count" } ], "query":"(logLevel: $$logLevel) && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "thresholds":[ ], "timeFrom":null, "timeRegions":[ ], "timeShift":null, "title":"$${logLevel} messages over time grouped by statusCode", "tooltip":{ "shared":true, "sort":0, "value_type":"individual" }, "transparent":true, "type":"graph", "xaxis":{ "buckets":null, "mode":"time", "name":null, "show":true, "values":[ ] }, "yaxes":[ { "format":"short", "label":null, "logBase":1, "max":null, "min":null, "show":true }, { "format":"short", "label":null, "logBase":1, "max":null, "min":null, "show":true } ], "yaxis":{ "align":false, "alignLevel":null } }, { "cacheTimeout":null, "datasource":"filebeat.${environment}.logevent-${artifact}", "gridPos":{ "h":4, "w":24, "x":0, "y":6 }, "id":35, "links":[ ], "options":{ "displayMode":"gradient", "fieldOptions":{ "calcs":[ "sum" ], "defaults":{ "decimals":0, "mappings":[ ], "max":10, "min":0, "thresholds":[ { "color":"green", "value":null }, { "color":"dark-orange", "value":1 }, { "color":"dark-red", "value":3 } ], "title":"Pod: $$__series_name", "unit":"none" }, "override":{ }, "values":false }, "orientation":"horizontal" }, "pluginVersion":"6.3.2", "targets":[ { "bucketAggs":[ { "fake":true, "field":"host.name", "id":"4", "settings":{ "min_doc_count":1, "missing":null, "order":"desc", "orderBy":"_count", "size":"0" }, "type":"terms" }, { "fake":true, "field":"ts", "id":"3", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "meta":{ }, "settings":{ }, "type":"count" } ], "query":"(logLevel: \"ERROR\") && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "timeFrom":"now-1h", "timeShift":null, "title":"Number of errors in the past hour", "transparent":true, "type":"bargauge" }, { "cacheTimeout":null, "datasource":"filebeat.${environment}.logevent-${artifact}", "gridPos":{ "h":8, "w":8, "x":0, "y":10 }, "id":33, "links":[ ], "options":{ "fieldOptions":{ "calcs":[ "sum" ], "defaults":{ "mappings":[ ], "max":10, "min":0, "thresholds":[ { "color":"green", "value":null }, { "color":"dark-orange", "value":1 }, { "color":"dark-red", "value":2 } ] }, "override":{ }, "values":false }, "orientation":"auto", "showThresholdLabels":false, "showThresholdMarkers":true }, "pluginVersion":"6.3.2", "targets":[ { "bucketAggs":[ { "fake":true, "field":"ts", "id":"3", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "type":"count" } ], "query":"(logLevel: \"ERROR\") && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "timeFrom":null, "timeShift":null, "title":"Total failed transactions", "transparent":true, "type":"gauge" }, { "aliasColors":{ "200":"#37872D", "201":"#56A64B", "400":"rgb(215, 0, 255)", "401":"rgb(185, 0, 255)", "403":"rgb(155, 0, 255)", "404":"#1F60C4", "405":"rgb(125, 0, 255)", "408":"rgb(95, 0, 255)", "409":"rgb(55, 0, 255)", "429":"#c4162a", "500":"rgb(255, 30, 0)", "501":"rgb(255, 60, 60)", "502":"rgb(255, 60, 0)", "503":"rgb(255, 90, 0)", "504":"rgb(255, 120, 0)", "505":"rgb(255, 150, 0)" }, "breakPoint":"50%", "cacheTimeout":null, "combine":{ "label":"Others", "threshold":0 }, "datasource":"filebeat.${environment}.logevent-${artifact}", "fontSize":"80%", "format":"short", "gridPos":{ "h":8, "w":8, "x":8, "y":10 }, "id":6, "interval":null, "legend":{ "show":true, "values":true }, "legendType":"Right side", "links":[ ], "maxDataPoints":3, "nullPointMode":"connected", "options":{ }, "pieType":"pie", "strokeWidth":1, "targets":[ { "bucketAggs":[ { "fake":true, "field":"transactionStatusCode", "id":"4", "settings":{ "min_doc_count":1, "order":"desc", "orderBy":"_term", "size":"15" }, "type":"terms" }, { "fake":true, "field":"ts", "id":"3", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "type":"count" } ], "query":"(logLevel: $$logLevel) && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "timeFrom":null, "timeShift":null, "title":"$${logLevel} messages grouped by status code", "transparent":true, "type":"grafana-piechart-panel", "valueName":"total" }, { "aliasColors":{ "/ah/test-api/v1/healthchock":"#8AB8FF" }, "breakPoint":"50%", "cacheTimeout":null, "combine":{ "label":"Others", "threshold":0 }, "datasource":"filebeat.${environment}.logevent-${artifact}", "fontSize":"80%", "format":"short", "gridPos":{ "h":8, "w":8, "x":16, "y":10 }, "id":7, "interval":null, "legend":{ "header":"", "show":true, "sideWidth":null, "values":true }, "legendType":"Under graph", "links":[ ], "maxDataPoints":3, "nullPointMode":"connected", "options":{ }, "pieType":"pie", "strokeWidth":1, "targets":[ { "bucketAggs":[ { "fake":true, "field":"invokedEndpoint.keyword", "id":"4", "settings":{ "min_doc_count":1, "order":"desc", "orderBy":"_term", "size":"0" }, "type":"terms" }, { "fake":true, "field":"ts", "id":"3", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "type":"count" } ], "query":"(logLevel: $$logLevel) && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "timeFrom":null, "timeShift":null, "title":"$${logLevel} messages grouped by requested endpoint", "transparent":true, "type":"grafana-piechart-panel", "valueName":"total" }, { "bgColor":null, "datasource":"filebeat.${environment}.logevent-${artifact}", "gridPos":{ "h":7, "w":24, "x":0, "y":18 }, "hideTimeOverride":true, "id":37, "options":{ }, "targets":[ { "bucketAggs":[ { "fake":true, "field":"invokedEndpoint.keyword", "id":"3", "settings":{ "min_doc_count":1, "missing":"0", "order":"desc", "orderBy":"_term", "size":"10" }, "type":"terms" }, { "field":"ts", "id":"2", "settings":{ "interval":"1d", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "hide":false, "metrics":[ { "field":"select field", "id":"1", "type":"count" } ], "query":"logLevel:\"ERROR\" AND tags:\"mule-application\"", "refId":"A", "timeField":"ts" } ], "timeFrom":"now-1y", "timeShift":null, "title":"Status of endpoints past 24h", "trafficLightSettings":{ "digits":0, "fontColor":"#FA6400", "fontSize":"12px", "greenThreshold":0, "invertScale":true, "lightsPerLine":5, "linkTargetBlank":false, "linkTooltip":"", "linkUrl":"", "max":100, "redThreshold":3, "renderLink":false, "showTrend":false, "showValue":true, "sortLights":true, "spreadControls":true, "units":" errors", "width":50 }, "transparent":true, "type":"snuids-trafficlights-panel" }, { "bgColor":null, "datasource":"filebeat.${environment}.logevent-${artifact}", "gridPos":{ "h":7, "w":24, "x":0, "y":25 }, "hideTimeOverride":true, "id":44, "options":{ }, "targets":[ { "bucketAggs":[ { "fake":true, "field":"host.name", "id":"3", "settings":{ "min_doc_count":1, "missing":"0", "order":"desc", "orderBy":"_term", "size":"10" }, "type":"terms" }, { "field":"ts", "id":"2", "settings":{ "interval":"1d", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "hide":false, "metrics":[ { "field":"select field", "id":"1", "type":"count" } ], "query":"logLevel:\"ERROR\" AND tags:\"mule-application\"", "refId":"A", "timeField":"ts" } ], "timeFrom":"now-2d", "timeShift":null, "title":"Status of host pods past 24h", "trafficLightSettings":{ "digits":0, "fontColor":"#FA6400", "fontSize":"12px", "greenThreshold":0, "invertScale":true, "lightsPerLine":5, "linkTargetBlank":false, "linkTooltip":"", "linkUrl":"", "max":100, "redThreshold":3, "renderLink":false, "showTrend":false, "showValue":true, "sortLights":true, "spreadControls":true, "units":" errors", "width":50 }, "transparent":true, "type":"snuids-trafficlights-panel" }, { "columns":[ { "text":"ts", "value":"ts" }, { "text":"host.name", "value":"host.name" }, { "text":"logLevel", "value":"logLevel" }, { "text":"httpMethod", "value":"httpMethod" }, { "text":"invokedEndpoint", "value":"invokedEndpoint" }, { "text":"transactionStatusCode", "value":"transactionStatusCode" }, { "text":"transactionStatusMessage", "value":"transactionStatusMessage" }, { "text":"payload.dataContent.error.errorMessage", "value":"payload.dataContent.error.errorMessage" }, { "text":"payload.dataContent.error.errorDescription", "value":"payload.dataContent.error.errorDescription" } ], "datasource":"filebeat.${environment}.logevent-${artifact}", "fontSize":"80%", "gridPos":{ "h":7, "w":24, "x":0, "y":32 }, "id":43, "links":[ ], "options":{ }, "pageSize":0, "scroll":true, "showHeader":true, "sort":{ "col":5, "desc":true }, "styles":[ { "alias":"Time", "dateFormat":"YYYY-MM-DD HH:mm:ss.SSS", "link":false, "pattern":"ts", "type":"date" }, { "alias":"HTTP Method", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "decimals":2, "pattern":"httpMethod", "thresholds":[ ], "type":"string", "unit":"short" }, { "alias":"Endpoint", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"invokedEndpoint", "thresholds":[ ], "type":"string", "unit":"short" }, { "alias":"Transaction status code", "colorMode":"row", "colors":[ "rgba(50, 172, 45, 0)", "rgba(89, 48, 16, 0.89)", "rgba(245, 54, 54, 0)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"transactionStatusCode", "thresholds":[ "400" ], "type":"string", "unit":"short" }, { "alias":"Level", "colorMode":null, "colors":[ "rgba(50, 172, 45, 0.97)", "rgba(237, 129, 40, 0.89)", "rgba(245, 54, 54, 0.9)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"logLevel", "rangeMaps":[ ], "thresholds":[ "WARN", " ERROR" ], "type":"string", "unit":"short" }, { "alias":"Payload Message", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"transactionStatusMessage", "preserveFormat":false, "rangeMaps":[ { "from":"", "text":"", "to":"" } ], "sanitize":false, "thresholds":[ ], "type":"string", "unit":"short", "valueMaps":[ ] }, { "alias":"Transaction description", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"payload.dataContent.error.errorDescription", "thresholds":[ ], "type":"string", "unit":"short" }, { "alias":"Error Message", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"payload.dataContent.error.errorMessage", "thresholds":[ ], "type":"number", "unit":"short" }, { "alias":"Pod Name", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"host.name", "thresholds":[ ], "type":"number", "unit":"short" } ], "targets":[ { "bucketAggs":[ ], "metrics":[ { "field":"select field", "id":"1", "meta":{ }, "settings":{ "size":500 }, "type":"raw_document" } ], "query":"(logLevel: $$logLevel) && (httpMethod: $$httpMethod) && (invokedEndpoint: $$invokedEndpoint) && (transactionStatusCode: $$transactionStatusCode) && (tags:\"mule-application\")", "refId":"A", "timeField":"ts" } ], "timeFrom":null, "timeShift":null, "title":"$${logLevel} Log messages", "transform":"json", "transparent":true, "type":"table" }, { "collapsed":false, "gridPos":{ "h":1, "w":24, "x":0, "y":39 }, "id":18, "panels":[ ], "title":"System Logger", "type":"row" }, { "cacheTimeout":null, "colorBackground":false, "colorValue":false, "colors":[ "#299c46", "rgba(237, 129, 40, 0.89)", "#d44a3a" ], "datasource":"filebeat.${environment}.logevent-${artifact}", "format":"none", "gauge":{ "maxValue":100, "minValue":0, "show":false, "thresholdLabels":false, "thresholdMarkers":true }, "gridPos":{ "h":5, "w":3, "x":0, "y":40 }, "id":27, "interval":null, "links":[ ], "mappingType":1, "mappingTypes":[ { "name":"value to text", "value":1 }, { "name":"range to text", "value":2 } ], "maxDataPoints":100, "nullPointMode":"connected", "nullText":null, "options":{ }, "pluginVersion":"6.3.2", "postfix":"", "postfixFontSize":"50%", "prefix":"", "prefixFontSize":"50%", "rangeMaps":[ { "from":"null", "text":"N/A", "to":"null" } ], "sparkline":{ "fillColor":"rgba(31, 118, 189, 0.18)", "full":false, "lineColor":"rgb(31, 120, 193)", "show":false, "ymax":null, "ymin":null }, "tableColumn":"", "targets":[ { "bucketAggs":[ { "field":"ts", "id":"2", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "meta":{ }, "settings":{ }, "type":"count" } ], "query":"(loglevel = $$logLevel) AND source: $$loggerName", "refId":"A", "timeField":"ts" } ], "thresholds":"", "timeFrom":null, "timeShift":null, "title":"Number of $${logLevel} messages", "transparent":true, "type":"singlestat", "valueFontSize":"80%", "valueMaps":[ { "op":"=", "text":"N/A", "value":"null" } ], "valueName":"total" }, { "aliasColors":{ "Count":"dark-red", "ERROR":"dark-red", "INFO":"semi-dark-green", "WARN":"dark-yellow" }, "bars":false, "dashLength":10, "dashes":false, "datasource":"filebeat.${environment}.logevent-${artifact}", "fill":8, "fillGradient":0, "gridPos":{ "h":10, "w":21, "x":3, "y":40 }, "id":29, "legend":{ "avg":false, "current":false, "max":false, "min":false, "show":true, "total":false, "values":false }, "lines":true, "linewidth":1, "links":[ ], "nullPointMode":"null", "options":{ "dataLinks":[ ] }, "percentage":false, "pointradius":2, "points":false, "renderer":"flot", "seriesOverrides":[ ], "spaceLength":10, "stack":true, "steppedLine":false, "targets":[ { "bucketAggs":[ { "fake":true, "field":"loglevel", "id":"3", "settings":{ "min_doc_count":1, "order":"desc", "orderBy":"_term", "size":"10" }, "type":"terms" }, { "field":"ts", "id":"2", "settings":{ "interval":"5m", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"1", "type":"count" } ], "query":"(loglevel = $$logLevel) AND source: $$loggerName", "refId":"A", "timeField":"ts" } ], "thresholds":[ ], "timeFrom":null, "timeRegions":[ ], "timeShift":null, "title":"$${logLevel} messages over time", "tooltip":{ "shared":true, "sort":0, "value_type":"individual" }, "transparent":true, "type":"graph", "xaxis":{ "buckets":null, "mode":"time", "name":null, "show":true, "values":[ ] }, "yaxes":[ { "format":"short", "label":null, "logBase":1, "max":null, "min":null, "show":true }, { "format":"short", "label":null, "logBase":1, "max":null, "min":null, "show":true } ], "yaxis":{ "align":false, "alignLevel":null } }, { "aliasColors":{ "ERROR":"#C4162A", "INFO":"#56A64B", "WARN":"#E0B400" }, "breakPoint":"50%", "cacheTimeout":null, "combine":{ "label":"Others", "threshold":0 }, "datasource":"filebeat.${environment}.logevent-${artifact}", "fontSize":"80%", "format":"short", "gridPos":{ "h":5, "w":3, "x":0, "y":45 }, "id":41, "interval":null, "legend":{ "show":false, "values":true }, "legendType":"Under graph", "links":[ ], "maxDataPoints":3, "nullPointMode":"connected", "options":{ }, "pieType":"pie", "strokeWidth":1, "targets":[ { "bucketAggs":[ { "fake":true, "field":"loglevel", "id":"4", "settings":{ "min_doc_count":1, "order":"desc", "orderBy":"_term", "size":"10" }, "type":"terms" }, { "field":"ts", "id":"2", "settings":{ "interval":"auto", "min_doc_count":0, "trimEdges":0 }, "type":"date_histogram" } ], "metrics":[ { "field":"select field", "id":"3", "type":"count" } ], "query":"(loglevel = $$logLevel) AND source: $$loggerName", "refId":"A", "timeField":"ts" } ], "timeFrom":null, "timeShift":null, "title":"Messages grouped by log level", "transparent":true, "type":"grafana-piechart-panel", "valueName":"total" }, { "columns":[ { "text":"ts", "value":"ts" }, { "text":"tags", "value":"tags" }, { "text":"loglevel", "value":"loglevel" }, { "text":"host.name", "value":"host.name" }, { "text":"message", "value":"message" } ], "datasource":"filebeat.${environment}.logevent-${artifact}", "fontSize":"80%", "gridPos":{ "h":7, "w":24, "x":0, "y":50 }, "id":13, "links":[ ], "options":{ }, "pageSize":0, "scroll":true, "showHeader":true, "sort":{ "col":0, "desc":true }, "styles":[ { "alias":"Time", "dateFormat":"YYYY-MM-DD HH:mm:ss.SSS", "link":false, "pattern":"ts", "type":"date" }, { "alias":"Source log", "colorMode":null, "colors":[ "rgba(245, 54, 54, 0.9)", "rgba(237, 129, 40, 0.89)", "rgba(50, 172, 45, 0.97)" ], "decimals":2, "pattern":"tags", "thresholds":[ ], "type":"string", "unit":"short" }, { "alias":"Level", "colorMode":null, "colors":[ "rgba(50, 172, 45, 0.97)", "rgba(237, 129, 40, 0.89)", "rgba(245, 54, 54, 0.9)" ], "dateFormat":"YYYY-MM-DD HH:mm:ss", "decimals":2, "mappingType":1, "pattern":"loglevel", "rangeMaps":[ ], "thresholds":[ "\"WARN\"", " \"ERROR\"" ], "type":"string", "unit":"short" } ], "targets":[ { "bucketAggs":[ ], "metrics":[ { "field":"select field", "id":"1", "meta":{ }, "settings":{ "size":500 }, "type":"raw_document" } ], "query":"(loglevel = $$logLevel) AND source: $$loggerName", "refId":"A", "timeField":"ts" } ], "timeFrom":null, "timeShift":null, "title":"$${logLevel} Log messages", "transform":"json", "transparent":true, "type":"table" }, { "content":"# [Full logs available here](${grafanaEndpoint}/explore?orgId=1&left=[\"now/d\",\"now\",\"filebeat.${environment}.logevent-${artifact}\",{\"query\":\"\",\"isLogsQuery\":true},{\"mode\":\"Logs\"},{\"ui\":[true,true,true,\"none\"]}])", "gridPos":{ "h":2, "w":24, "x":0, "y":57 }, "id":39, "links":[ { "title":"Logs", "url":"${grafanaEndpoint}/explore?orgId=1&left=[\"now/d\",\"now\",\"filebeat.${environment}.logevent-${artifact}\",{\"query\":\"\",\"isLogsQuery\":true},{\"mode\":\"Logs\"},{\"ui\":[true,true,true,\"none\"]}]" } ], "mode":"markdown", "options":{ }, "timeFrom":null, "timeShift":null, "title":"", "transparent":true, "type":"text" } ], "refresh":false, "schemaVersion":19, "style":"dark", "tags":[ "monitoring", "${environment}", "Filebeat", "${projectname}" ], "templating":{ "list":[ { "datasource":"filebeat.${environment}.logevent-${artifact}", "filters":[ ], "hide":0, "label":"", "name":"Filters", "skipUrlSync":false, "type":"adhoc" }, { "allValue":"", "current":{ "tags":[ ], "text":"All", "value":[ "$$__all" ] }, "hide":0, "includeAll":true, "label":null, "multi":true, "name":"logLevel", "options":[ { "selected":true, "text":"All", "value":"$$__all" }, { "selected":false, "text":"INFO", "value":"INFO" }, { "selected":false, "text":"WARN", "value":"WARN" }, { "selected":false, "text":"ERROR", "value":"ERROR" }, { "selected":false, "text":"DEBUG", "value":"DEBUG" } ], "query":"INFO,WARN,ERROR,DEBUG", "skipUrlSync":false, "type":"custom" }, { "allValue":"", "current":{ "text":"All", "value":[ "$$__all" ] }, "datasource":"filebeat.${environment}.logevent-${artifact}", "definition":"{\"find\": \"terms\", \"field\": \"httpMethod\"}", "hide":0, "includeAll":true, "label":null, "multi":true, "name":"httpMethod", "options":[ ], "query":"{\"find\": \"terms\", \"field\": \"httpMethod\"}", "refresh":2, "regex":"", "skipUrlSync":false, "sort":0, "tagValuesQuery":"", "tags":[ ], "tagsQuery":"", "type":"query", "useTags":false }, { "allValue":"", "current":{ "text":"All", "value":[ "$$__all" ] }, "datasource":"filebeat.${environment}.logevent-${artifact}", "definition":"{\"find\": \"terms\", \"field\": \"invokedEndpoint.keyword\"}", "hide":0, "includeAll":true, "label":null, "multi":true, "name":"invokedEndpoint", "options":[ ], "query":"{\"find\": \"terms\", \"field\": \"invokedEndpoint.keyword\"}", "refresh":2, "regex":"", "skipUrlSync":false, "sort":2, "tagValuesQuery":"", "tags":[ ], "tagsQuery":"", "type":"query", "useTags":false }, { "allValue":"", "current":{ "tags":[ ], "text":"All", "value":[ "$$__all" ] }, "datasource":"filebeat.${environment}.logevent-${artifact}", "definition":"{\"find\": \"terms\", \"field\": \"source\"}", "hide":0, "includeAll":true, "label":null, "multi":true, "name":"loggerName", "options":[ ], "query":"{\"find\": \"terms\", \"field\": \"source\"}", "refresh":2, "regex":"", "skipUrlSync":false, "sort":2, "tagValuesQuery":"", "tags":[ ], "tagsQuery":"", "type":"query", "useTags":false }, { "allValue":"", "current":{ "text":"All", "value":[ "$$__all" ] }, "datasource":"filebeat.${environment}.logevent-${artifact}", "definition":"{\"find\": \"terms\", \"field\": \"transactionStatusCode\"}", "hide":0, "includeAll":true, "label":"Returned HTTP status code", "multi":true, "name":"transactionStatusCode", "options":[ ], "query":"{\"find\": \"terms\", \"field\": \"transactionStatusCode\"}", "refresh":2, "regex":"", "skipUrlSync":false, "sort":0, "tagValuesQuery":"", "tags":[ ], "tagsQuery":"", "type":"query", "useTags":false } ] }, "time":{ "from":"now/d", "to":"now/d" }, "timepicker":{ "refresh_intervals":[ "5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d" ], "time_options":[ "5m", "15m", "1h", "6h", "12h", "24h", "2d", "7d", "30d" ] }, "timezone":"", "title":"${updateddashboardname} Dashboard", "uid":null, "id":null, "message":"Automatic generation of dashboard", "version":1 } } /$
    }

    // Create Dashboard
    def dashhttp = new URL("${dashboardEndpoint}").openConnection() as HttpURLConnection
    dashhttp.setRequestMethod('POST')
    dashhttp.setDoOutput(true)
    dashhttp.setRequestProperty("Accept", 'application/json')
    dashhttp.setRequestProperty("Content-Type", 'application/json')
    dashhttp.setRequestProperty("Authorization", "${grafanaUser}")
    dashhttp.outputStream.write(dashboardbody.getBytes("UTF-8"))
    dashhttp.connect()
    def dashresponse = [: ]
    if (dashhttp.responseCode == 200) {
     dashresponse = new JsonSlurper().parseText(dashhttp.inputStream.getText('UTF-8'))
     echo "Dashboard Created  ${dashhttp.responseCode} : ${dashresponse}"
    } else if (dashhttp.responseCode == 409) {
     dashresponse = new JsonSlurper().parseText(dashhttp.errorStream.getText('UTF-8'))
     echo "Dashboard already exist for the artifact ${artifact} in ${environment} environment"
    } else if (dashhttp.responseCode == 412) {
     dashresponse = new JsonSlurper().parseText(dashhttp.errorStream.getText('UTF-8'))
     echo "Dashboard already exist for the artifact ${artifact} in ${environment} environment"
    } else {
     dashresponse = new JsonSlurper().parseText(dashhttp.errorStream.getText('UTF-8'))
     echo "There is an issue while creating the Dashboard and the reason for that is ${dashhttp.responseCode} : ${dashresponse}"
     currentBuild.result = 'FAILURE'
    }
    } // end WithCredentials Block
 } catch (err) {
  echo "in catch block"
  echo "Caught: ${err}"
  currentBuild.result = 'FAILURE'
  throw err
 }

} // end Stage
